name: Deploy
on:
    push:
      branches: [ "master" ]
jobs:
    deploy:
      runs-on: ubuntu-latest
      environment: staging
      env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST_USER: ${{ secrets.HOST_USER }}
          HOST_ADDRESS: ${{ secrets.HOST_ADDRESS }}
          ENVIRONMENT: staging
          DOMAIN: ${{vars.DOMAIN}}
          SERVER_HOST: ${{vars.SERVER_HOST}}
          POSTGRES_DB: ${{vars.POSTGRES_DB}}
          POSTGRES_USER: ${{vars.POSTGRES_USER}}
          POSTGRES_PASSWORD: ${{vars.POSTGRES_PASSWORD}}
          POSTGRES_DSN: ${{vars.POSTGRES_DSN}}

      steps:
          - uses: actions/checkout@v4
          - name: Load and create private key
            run: |
                echo '-----BEGIN OPENSSH PRIVATE KEY-----' > private_key
                echo $SSH_PRIVATE_KEY >> private_key
                echo '-----END OPENSSH PRIVATE KEY-----' >> private_key
                chmod 600 private_key
          - name: Connect to server and execute command
            run: |
                ssh -o StrictHostKeyChecking=no -i private_key $HOST_USER@$HOST_ADDRESS << EOF
                  cd projects/go_server
                  echo HOST_USER $HOST_USER
                  git pull origin master
                  docker compose -f docker-compose-staging.yml down
                  docker compose -f docker-compose-staging.yml up -d app
                EOF
